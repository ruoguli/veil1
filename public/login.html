<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veil - 登录</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <canvas id="aurora-canvas"></canvas>

    <div class="scene" id="loginScene" style="opacity: 0; transition: opacity 0.3s ease;">
        <div id="loginCard" class="card-3d w-full max-w-[360px] p-10 rounded-[40px] flex flex-col items-center">

            <div class="flex flex-col items-center mb-8 layer-3">
                <div class="w-[84px] h-[84px] logo-container rounded-[24px] flex items-center justify-center mb-5">
                    <i class="ph ph-envelope-simple text-[40px] text-[#007AFF]" style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;"></i>
                </div>
                <h1 class="text-2xl font-semibold text-gray-900 tracking-tight">Veil</h1>
                <p class="text-sm text-gray-500 mt-1">临时邮箱服务</p>
            </div>

            <form id="loginForm" class="space-y-6 w-full layer-2">
                <div class="group space-y-2">
                    <div class="flex items-center gap-2 text-gray-500 pl-1">
                        <i class="ph ph-user text-base"></i>
                        <span class="text-[14px] font-medium tracking-wide">用户名</span>
                    </div>
                    <input type="text" id="loginUsername" placeholder="请输入用户名"
                           class="apple-input w-full h-[50px] px-4 rounded-[16px] text-[15px] outline-none"
                           autocomplete="username" required>
                </div>

                <div class="group space-y-2">
                    <div class="flex items-center gap-2 text-gray-500 pl-1">
                        <i class="ph ph-lock text-base"></i>
                        <span class="text-[14px] font-medium tracking-wide">密码</span>
                    </div>
                    <input type="password" id="loginPassword" placeholder="请输入密码"
                           class="apple-input w-full h-[50px] px-4 rounded-[16px] text-[15px] outline-none"
                           autocomplete="current-password" required>
                </div>

                <div id="errorMsg" class="text-red-500 text-sm text-center hidden"></div>

                <div class="mt-8 w-full layer-3">
                    <button type="submit" id="loginBtn"
                            class="apple-btn w-full h-[50px] text-white font-medium rounded-[16px] flex items-center justify-center gap-2 cursor-pointer">
                        <span>登录</span>
                        <i class="ph ph-arrow-right text-base opacity-80"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="toast" id="toast">
        <i class="ph-bold ph-check"></i>
        <span id="toastMsg">成功</span>
    </div>

    <script type="module">
        import { startAurora, initCard3D } from '/js/aurora.js';
        import { login, checkSession, getRedirectUrl } from '/js/auth.js';
        import { showToast } from '/js/common.js';

        // 初始化背景动画和3D卡片
        startAurora();
        initCard3D('loginCard');

        const loginScene = document.getElementById('loginScene');

        // 检查是否已登录
        async function checkAuth() {
            try {
                const user = await checkSession();
                if (user) {
                    // 已登录，直接跳转，不显示登录表单
                    window.location.href = getRedirectUrl(user);
                    return;
                }
            } catch (e) {
                console.error('Auth check failed:', e);
            }
            // 未登录，显示登录表单
            loginScene.style.opacity = '1';
        }
        checkAuth();

        // 登录表单处理
        const form = document.getElementById('loginForm');
        const usernameInput = document.getElementById('loginUsername');
        const passwordInput = document.getElementById('loginPassword');
        const errorMsg = document.getElementById('errorMsg');
        const loginBtn = document.getElementById('loginBtn');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                showError('请输入用户名和密码');
                return;
            }

            // 禁用按钮，显示加载状态
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="ph ph-spinner spinning"></i> <span>登录中...</span>';

            const result = await login(username, password);

            if (result.success) {
                showToast('登录成功');
                // 跳转到对应页面
                setTimeout(() => {
                    window.location.href = getRedirectUrl(result.user);
                }, 500);
            } else {
                showError(result.error);
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<span>登录</span><i class="ph ph-arrow-right text-base opacity-80"></i>';
            }
        });

        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.classList.remove('hidden');
            setTimeout(() => {
                errorMsg.classList.add('hidden');
            }, 3000);
        }

        // 回车提交
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                form.dispatchEvent(new Event('submit'));
            }
        });
    </script>
</body>
</html>
