<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veil - 管理控制台</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        /* 防止加载时黑屏 */
        body.app-mode { background-color: #EEF0F2; }
    </style>
</head>
<body class="app-mode">
    <div id="app-view" style="opacity: 1; transform: none; filter: none; pointer-events: auto;">
        <!-- 移动端侧边栏遮罩（放在 #app-view 内，保证层级低于 sidebar 但高于主内容） -->
        <div class="sidebar-overlay"></div>

        <div class="app-window">
            <!-- 侧边栏 -->
            <aside class="sidebar">
                <div class="brand">
                    <div class="brand-icon">
                        <i class="ph ph-envelope-simple" style="font-size: 20px;"></i>
                    </div>
                    <div class="brand-text">Veil</div>
                </div>

                <ul class="nav-menu">
                    <li class="nav-item active" onclick="switchView('home', this)">
                        <i class="ph ph-plus-circle" style="font-size: 18px;"></i> 生成邮箱
                    </li>
                    <li class="nav-item" onclick="switchView('users', this)">
                        <i class="ph ph-users" style="font-size: 18px;"></i> 用户管理
                    </li>
                    <li class="nav-item" onclick="switchView('all-emails', this)">
                        <i class="ph ph-list" style="font-size: 18px;"></i> 所有邮箱
                    </li>
                </ul>

                <div class="user-profile-container">
                    <div class="user-menu" id="userMenu">
                        <div class="menu-item">
                            <i class="ph-bold ph-sign-out"></i> 退出登录
                        </div>
                    </div>
                    <div class="user-profile">
                        <div class="avatar">A</div>
                        <div style="flex:1;">
                            <div class="name-text" style="font-size:14px; font-weight:600; color:#1c1c1e;">Super Admin</div>
                            <span class="badge-admin">Super Admin</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- 主内容区 -->
            <main class="main-content">
                <!-- 移动端头部 -->
                <div class="mobile-header" style="display: none;">
                    <button class="menu-toggle" onclick="document.querySelector('.sidebar').classList.add('open'); document.querySelector('.sidebar-overlay').classList.add('show');">
                        <i class="ph ph-list"></i>
                    </button>
                    <div class="brand" style="margin: 0;">
                        <div class="brand-icon" style="width: 28px; height: 28px;">
                            <i class="ph ph-envelope-simple" style="font-size: 16px;"></i>
                        </div>
                        <div class="brand-text" style="font-size: 17px;">Veil</div>
                    </div>
                    <div style="width: 40px;"></div>
                </div>

                <!-- 视图1: 生成邮箱 -->
                <div id="view-home" class="view-section active">
                    <header class="toolbar">
                        <a href="https://github.com/li1679/veil" class="github-pill" target="_blank">
                            <i class="ph-fill ph-github-logo"></i>
                            <span>GitHub</span>
                        </a>
                    </header>

                    <div class="content-body">
                        <div class="email-display-container" onclick="scrollToInbox()">
                            <div class="current-email" id="fullEmailDisplay">
                                <span id="prefixText"></span><span id="suffixText" style="color:var(--label-secondary);"></span>
                            </div>
                            <div class="click-hint">点击查看收件箱</div>
                        </div>

                        <div class="actions-row disabled" id="actionButtons">
                            <button class="btn btn-secondary" onclick="copyEmail()"><i class="ph-bold ph-copy"></i> <span>复制</span></button>
                            <button class="btn btn-secondary" onclick="refreshInbox()"><i class="ph-bold ph-arrows-clockwise"></i> <span>刷新</span></button>
                            <button class="btn btn-primary" onclick="openSendModal()"><i class="ph-bold ph-paper-plane-tilt"></i> <span>发送</span></button>
                            <button class="btn btn-danger" onclick="confirmClearInbox()"><i class="ph-bold ph-trash"></i> <span>清空</span></button>
                        </div>

                        <div class="dashboard-grid">
                            <div class="panel-group">
                                <div class="group-header">生成配置</div>
                                <div class="ios-card">
                                    <div style="font-size:13px; margin-bottom:6px; font-weight:500;">域名后缀</div>
                                    <div class="custom-select-wrapper" id="domainSelectWrapper">
                                        <div class="select-trigger" onclick="toggleDropdown()">
                                            <span id="selectedDomain">加载中...</span>
                                            <i class="ph-bold ph-caret-down" style="color:#86868B;"></i>
                                        </div>
                                        <ul class="options-list" id="domainOptions"></ul>
                                    </div>

                                    <div class="form-row" style="display:flex; justify-content:space-between; align-items:center; background:#F9F9F9; padding:12px; border-radius:8px; margin-bottom:20px;">
                                        <div>
                                            <div style="font-size:14px; font-weight:500;">随机域名后缀</div>
                                            <div style="font-size:12px; color:#3C3C4399;">开启后每次生成都会随机选择域名</div>
                                        </div>
                                        <div class="ios-switch" id="randomDomainSwitch" onclick="toggleRandomDomain()">
                                            <div class="ios-switch-thumb"></div>
                                        </div>
                                    </div>

                                    <div style="font-size:13px; margin-bottom:6px; font-weight:500;">前缀模式</div>
                                    <div class="segment-container">
                                        <div class="segment-bg" id="segmentBg"></div>
                                        <button class="segment-btn active" onclick="setPrefixMode(this, 'random', 0)">随机</button>
                                        <button class="segment-btn" onclick="setPrefixMode(this, 'name', 1)">人名</button>
                                        <button class="segment-btn" onclick="setPrefixMode(this, 'custom', 2)">自定义</button>
                                    </div>

                                    <input type="text" class="custom-input" id="customInputBox" placeholder="输入自定义前缀...">

                                    <div id="lengthSection" class="slider-container">
                                        <div class="slider-header">
                                            <span>长度</span>
                                            <span id="lengthDisplay" style="color:var(--accent-blue);">12</span>
                                        </div>
                                        <input type="range" id="lengthSlider" min="4" max="20" value="12" oninput="updateLengthLabel(this.value)">
                                    </div>

                                    <button class="btn btn-primary" onclick="generateEmail()" style="width: 100%; margin-top: 24px; justify-content: center;">
                                        立即生成
                                    </button>
                                </div>
                            </div>

                            <div class="panel-group">
                                <div style="display:flex; justify-content:space-between; align-items:center; padding:0 16px;">
                                    <div class="group-header" style="padding:0;">历史邮箱</div>
                                    <i class="ph ph-trash" onclick="confirmClearHistory()" style="font-size:14px; color:var(--label-secondary); cursor:pointer;" title="清空所有"></i>
                                </div>
                                <div class="ios-card" style="padding: 10px 20px;">
                                    <div class="history-list" id="historyListContainer">
                                        <div style="text-align:center; padding: 20px; color:var(--label-tertiary); font-size:13px;">
                                            加载中...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="inbox-section" id="inboxSection">
                            <div class="inbox-header">
                                <div class="inbox-title"><span class="status-dot"></span> 收件箱</div>
                                <div style="font-size:13px; color:var(--label-secondary);">监听中</div>
                            </div>
                            <div id="inboxContainer" class="inbox-empty">
                                <i class="ph ph-tray"></i>
                                <span>暂无新邮件</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 视图2: 用户管理 -->
                <div id="view-users" class="view-section">
                    <div class="content-scroll">
                        <div class="header">
                            <div>
                                <div class="title">用户管理</div>
                                <div style="font-size:14px; color:#3C3C4399; margin-top:4px;">管理用户权限、邮箱配额及发件设置</div>
                            </div>
                            <div class="actions">
                                <button class="btn btn-primary" onclick="openUserModal()"><i class="ph-bold ph-plus"></i> 新增用户</button>
                            </div>
                        </div>

                        <div class="card">
                            <div class="t-header">
                                <div style="display: flex; justify-content: center;">
                                    <div class="custom-checkbox" id="selectAllUsersCheckbox" onclick="toggleSelectAllUsers()"></div>
                                </div>
                                <div>头像</div>
                                <div>用户基本信息</div>
                                <div>发件权限</div>
                                <div>邮箱配额</div>
                                <div>用户角色</div>
                                <div>账户状态</div>
                                <div>操作</div>
                                <div></div>
                            </div>
                            <div id="userTableBody">
                                <div style="padding: 40px; text-align: center; color: #999;">加载中...</div>
                            </div>
                        </div>

                        <div class="batch-bar" id="userBatchBar">
                            <div class="batch-info">已选择 <span id="selectedUsersCount">0</span> 位用户</div>
                            <button class="batch-btn danger" onclick="batchDeleteUsers()"><i class="ph-bold ph-trash"></i> 批量删除</button>
                            <button class="batch-btn" style="opacity: 0.7; margin-left: 8px;" onclick="cancelUserSelection()"><i class="ph-bold ph-x"></i> 取消</button>
                        </div>
                    </div>
                </div>

                <!-- 视图3: 所有邮箱 -->
                <div id="view-all-emails" class="view-section">
                    <div class="module-header">
                        <div class="module-title">
                            <h1>所有邮箱</h1>
                            <p>管理系统中所有生成的邮箱账号</p>
                        </div>
                        <div class="filter-row">
                            <select class="filter-select" id="userFilter" onchange="filterByUser()">
                                <option value="">全部用户</option>
                            </select>
                            <select class="filter-select" id="domainFilter" onchange="filterByDomain()">
                                <option value="">全部域名</option>
                            </select>
                            <div class="search-bar">
                                <i class="ph-bold ph-magnifying-glass search-icon"></i>
                                <input type="text" class="search-input" id="emailSearchInput" placeholder="搜索邮箱或前缀...">
                            </div>
                        </div>
                    </div>

                    <div class="email-table-container">
                        <div class="email-card">
                             <div class="e-header">
                                 <div style="display: flex; justify-content: center;">
                                     <div class="custom-checkbox" id="selectAllEmailsCheckbox" onclick="toggleSelectAllEmails()"></div>
                                 </div>
                                 <div>邮箱地址</div>
                                 <div>创建者</div>
                                 <div>备注</div>
                                 <div>登录密码</div>
                                 <div>登录状态</div>
                                 <div>创建时间</div>
                                 <div style="text-align: right;">操作</div>
                             </div>
                            <div id="emailListBody">
                                <div style="padding: 40px; text-align: center; color: #999;">加载中...</div>
                            </div>
                        </div>
                    </div>

                    <div class="batch-bar" id="emailBatchBar">
                        <div class="batch-info">已选择 <span id="selectedEmailsCount">0</span> 项</div>
                        <button class="batch-btn" onclick="batchToggleLoginEmails(true)"><i class="ph-bold ph-check-circle"></i> 允许登录</button>
                        <button class="batch-btn" onclick="batchToggleLoginEmails(false)"><i class="ph-bold ph-prohibit"></i> 禁止登录</button>
                        <button class="batch-btn danger" onclick="batchDeleteEmails()"><i class="ph-bold ph-trash"></i> 删除</button>
                        <button class="batch-btn" style="opacity: 0.7; margin-left: 8px;" onclick="cancelEmailSelection()"><i class="ph-bold ph-x"></i> 取消</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"><i class="ph-bold ph-check"></i> <span id="toastMsg">成功</span></div>

    <!-- 发送邮件模态框 -->
    <div class="modal-overlay" id="sendModalOverlay">
        <div class="sheet-modal">
            <div class="sheet-header">
                <button class="sheet-btn" onclick="closeSendModal()">取消</button>
                <div style="font-weight:600; font-size:16px;">新邮件</div>
                <button class="sheet-btn send" id="sendBtn" onclick="doSendEmail()">发送</button>
            </div>
            <div class="sheet-body">
                <div class="compose-field">
                    <span class="compose-label">发件名称:</span>
                    <input type="text" class="compose-input" id="senderNameInput" placeholder="例如: Veil" oninput="checkComposeInput()">
                </div>
                <div class="compose-field">
                    <span class="compose-label">收件人:</span>
                    <input type="text" class="compose-input" id="toInput" placeholder="recipient@example.com" oninput="checkComposeInput()">
                </div>
                <div class="compose-field">
                    <span class="compose-label">主题:</span>
                    <input type="text" class="compose-input" id="subjectInput" placeholder="邮件主题" oninput="checkComposeInput()">
                </div>
                <textarea class="compose-area" id="contentInput" placeholder="输入邮件正文..." oninput="checkComposeInput()"></textarea>
            </div>
        </div>
    </div>

    <!-- 邮件详情模态框 -->
    <div class="modal-overlay" id="mailDetailModal">
        <div class="sheet-modal" style="height: auto; max-height: 80vh;">
            <div class="sheet-header">
                <button class="sheet-btn" onclick="closeMailDetail()">关闭</button>
                <div style="font-weight:600; font-size:16px;">邮件详情</div>
                <div style="width: 50px;"></div>
            </div>
            <div class="mail-detail-header">
                <div class="mail-detail-subject" id="mailDetailSubject"></div>
                <div class="mail-detail-meta">
                    <div class="mail-detail-avatar" id="mailDetailAvatar"></div>
                    <div class="mail-detail-info">
                        <div class="mail-detail-from" id="mailDetailFrom"></div>
                        <div class="mail-detail-to">收件人: <span id="mailDetailTo"></span></div>
                    </div>
                    <div class="mail-detail-time" id="mailDetailTime"></div>
                </div>
            </div>
            <div class="mail-detail-body" id="mailDetailBody"></div>
        </div>
    </div>

    <!-- 邮箱收件箱查看器 -->
    <div class="modal-overlay" id="mailboxViewerModal">
        <div class="sheet-modal mailbox-viewer-modal">
            <div class="sheet-header mailbox-viewer-header">
                <button class="sheet-btn" onclick="closeMailboxViewer()">关闭</button>
                <div class="viewer-title">
                    <div style="font-weight:600; font-size:16px;">收件箱</div>
                    <div class="viewer-address" id="mailboxViewerAddress"></div>
                </div>
                <button class="sheet-btn" onclick="refreshMailboxViewer()">刷新</button>
            </div>
            <div class="mailbox-viewer-body">
                <div class="viewer-meta" id="mailboxViewerCount">加载中...</div>
                <div id="mailboxViewerList" class="mailbox-viewer-list"></div>
            </div>
        </div>
    </div>

    <!-- 用户编辑模态框 -->
    <div class="modal-overlay" id="userModal">
        <div class="modal-card">
            <h3 style="font-size:18px; font-weight:700; margin-bottom:20px;" id="modalTitle">编辑用户</h3>

            <div class="form-row">
                <label class="form-label">用户昵称</label>
                <input type="text" class="form-input" id="inputName" placeholder="例如: Alice Zhang">
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
                <div class="form-row">
                    <label class="form-label">登录用户名</label>
                    <input type="text" class="form-input" id="inputLoginUsername" placeholder="请输入用户名">
                </div>
                <div class="form-row">
                    <label class="form-label">登录密码</label>
                    <input type="password" class="form-input" id="inputPassword" placeholder="留空则不修改">
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr; gap:16px;">
                <div class="form-row">
                    <label class="form-label">邮箱生成配额</label>
                    <input type="number" class="form-input" id="inputQuota" value="10" min="1">
                </div>
            </div>

            <div class="form-row" style="display:flex; justify-content:space-between; align-items:center; background:#F9F9F9; padding:12px; border-radius:8px;">
                <div>
                    <div style="font-size:14px; font-weight:500;">允许发送邮件</div>
                    <div style="font-size:12px; color:#3C3C4399;">开启后该用户可发送邮件</div>
                </div>
                <div class="ios-switch" id="inputSendSwitch" onclick="this.classList.toggle('on')">
                    <div class="ios-switch-thumb"></div>
                </div>
            </div>

            <div class="form-row" id="initialEmailRow">
                <label class="form-label">初始邮箱 (可选)</label>
                <div class="input-group">
                    <input type="text" class="form-input" id="inputInitialEmail" placeholder="邮箱前缀" style="text-align:right;">
                    <span class="input-addon">@</span>
                    <select class="form-input" id="inputInitialDomain" style="flex:1.2;"></select>
                </div>
                <div style="font-size:11px; color:#999; margin-top:4px;">留空则不分配初始邮箱</div>
            </div>

            <input type="hidden" id="editUserId">

            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('userModal')">取消</button>
                <button class="btn btn-primary" onclick="saveUser()">保存</button>
            </div>
        </div>
    </div>

    <!-- 分配邮箱模态框 -->
    <div class="modal-overlay" id="assignEmailModal">
        <div class="modal-card">
            <h3 style="font-size:18px; font-weight:700; margin-bottom:20px;">分配新邮箱</h3>
            <p style="font-size:14px; color:#3C3C4399; margin-bottom:20px;">手动指定该用户的新邮箱地址。</p>

            <div class="form-row">
                <label class="form-label">邮箱地址</label>
                <div class="input-group">
                    <input type="text" class="form-input" id="assignPrefix" placeholder="邮箱前缀" style="text-align:right;">
                    <span class="input-addon">@</span>
                    <select class="form-input" id="assignDomain" style="flex:1.2;"></select>
                </div>
            </div>

            <input type="hidden" id="assignUserId">

            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('assignEmailModal')">取消</button>
                <button class="btn btn-primary" onclick="confirmAssignEmail()">确认分配</button>
            </div>
        </div>
    </div>

    <!-- 密码修改模态框 -->
    <div class="modal-overlay" id="passwordModal">
        <div class="modal-card" style="width: 400px;">
            <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">修改密码</h3>
            <p style="font-size: 14px; color: #666; margin-bottom: 20px;">
                当前正在修改 <span id="pwdEditEmail" style="color: var(--accent-blue); font-weight: 500;"></span> 的密码。
            </p>

            <label style="font-size: 13px; font-weight: 600; color: #333;">原密码</label>
            <div class="input-group">
                <input type="text" class="form-input" id="oldPasswordInput" readonly>
                <button class="btn btn-ghost" style="height: 38px; border-radius: 10px; padding: 0 14px;" onclick="copyOldPassword(event)">复制</button>
            </div>
            <div id="oldPasswordHint" style="font-size: 12px; color: #999; margin-top: 6px; display: flex; align-items: center; gap: 4px;"></div>

            <div style="height: 14px;"></div>
            <label style="font-size: 13px; font-weight: 600; color: #333;">新密码</label>
            <input type="password" class="form-input" id="newPasswordInput" autocomplete="new-password">
            <div style="font-size: 12px; color: #999; margin-top: 6px; display: flex; align-items: center; gap: 4px;">
                <i class="ph-fill ph-info"></i> 默认密码通常为邮箱地址本身
            </div>

            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closePwdModal()">取消</button>
                <button class="btn btn-primary" onclick="savePassword()">保存修改</button>
            </div>
        </div>
    </div>

    <!-- 备注编辑模态框 -->
    <div class="modal-overlay" id="remarkModal">
        <div class="modal-card" style="width: 440px;">
            <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">编辑备注</h3>
            <p style="font-size: 14px; color: #666; margin-bottom: 20px;">
                当前邮箱：<span id="remarkEditEmail" style="color: var(--accent-blue); font-weight: 500;"></span>
            </p>

            <label style="font-size: 13px; font-weight: 600; color: #333;">备注</label>
            <textarea class="form-input" id="remarkInput" placeholder="最多200字，可留空清空" style="height: 110px; resize: none;"></textarea>

            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeRemarkModal()">取消</button>
                <button class="btn btn-primary" onclick="saveRemark()">保存</button>
            </div>
        </div>
    </div>

    <!-- iOS 确认框 -->
    <div class="modal-overlay" id="iosAlertModal">
        <div class="ios-alert-box">
            <div class="ios-alert-content">
                <h3 id="iosAlertTitle" class="ios-alert-title">确认操作</h3>
                <p id="iosAlertDesc" class="ios-alert-desc">确定要继续吗？</p>
            </div>
            <div class="ios-alert-buttons">
                <button class="ios-alert-btn cancel">取消</button>
                <button id="iosAlertConfirmBtn" class="ios-alert-btn destruct">确定</button>
            </div>
        </div>
    </div>

    <script type="module" src="/js/admin.js"></script>

    <style>
        /* 移动端显示头部 */
        @media (max-width: 768px) {
            .mobile-header { display: flex !important; }
        }
    </style>
</body>
</html>
